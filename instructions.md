
# Lab prerequisites
  1. Visual Studio Code.
  2. Github account.
  3. Azure Develper CLI [Install the Azure Developer CLI | Microsoft Learn](https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/install-azd?tabs=winget-windows%2Cbrew-mac%2Cscript-linux&pivots=os-windows)
  4. Create a local folder on your machine for the code.
  5. In the folder path created in the above step, clone this repo on your local machine (git clone)
  6. Deploy the environment.
  7. After deployment is completed, validate that the following resources are now in the resources group you just created.
  
  ## Lab 1
  ### Configure a Logic App Standard as a API Management backend for writing messages on service bus
  #### Steps
  1. From the logicapp-1-xxxx, deploy and configure (trigger and actions) so our worklfow be able to receive requests from the API Management instance.

     The request body is 
    {
    "nombre": "string",
    "apellido": "string",
    "direccion":"string",
    "contacto":"string"
    }

  2. In the "parameters" section of the "Compose" action, configure the input, including with the above mentioned body.
  3. Using the Service Bus "Send Message" connector, add an action for send messages to the Service Bus instance. Configure the nanmespace connection with the managed identity assigned to        the logic app and that was automatically generated by the deployment.

     To configure the Service bus connection from the Azure Portal:

     Go to the Service bus instance >> Shared Access Policies >> RootManageSharedAccessKey >> Primary Connection String

     Once the configuration is done, our action shape on the logic app will look like this:

  4. Add and configure a "Response" action:
     
  5. In the body add outputs('Compose')?['order_id']
  6. Finally, we will have the following workfloW:
  7. Save the changes.
  8. Copy the logic app URL.
  9. Divide the URL in two parts.

#### Complete URL
    
https://logicapp-1-3obbnrwlgsmby.azurewebsites.net:443/api/apimtriggersb/triggers/When_a_HTTP_request_is_received/invoke?api-version=2022-05-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=G6Mm5OvSduxJQaa8c09awMfvoJbqZgTrBOT_GUUFQ1A

#### Part 1:
https://logicapp-1-3obbnrwlgsmby.azurewebsites.net:443

#### Part 2: 
/api/apimtriggersb/triggers/When_a_HTTP_request_is_received/invoke?api-version=2022-05-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=G6Mm5OvSduxJQaa8c09awMfvoJbqZgTrBOT_GUUFQ1A

 10. From the APIS section from our API Management instance, click in "+ Add API >> HTTP >> fill the name and URL (Part 1 of the above URL) and then click in "Create".
 11. From our new API, click in "+ Add operatio" and complete the information as below indicates. To the URL field, select the "POST" method and the Part 2 of the URL.
 12. Save the changes.
 13. Test the "POST" method in the "Test" section of out API Management instance. We can also test it with Postman.
 14. Verify that we can obtarin 200 HTTP response and that the message is suscribed on the "orders" Service bus topic.

## Lab 2
### Configure an Azure Function that generates a file on an Azure Storage Account once a Service Bus message is generated from previous lab.
#### Steps

1. From VS Code, validate that the class "ServiceBusTopicTriggerToBlobSt.cs" from the Azure Function, contains the following C# code:
2. Deploy it in Azure:
3. From the VS Code command pallete, select the subscription we are working on and the Azure Function before deployed.
     Once deployed, from the Azure Portal, go the the "Environment Variables" section adn add the keys and values for the connection strings and storage account.

   Service Bus Connection:
   Azure Portal >> Service bus instance >> Shared Access Policies >> RootManageSharedAccessKey >> Primary Connection String

   Storage Account Connection:
   Azure Portal >> Storage account >> Access keys >> Connection string

4. Save the changes.
5. Test from API Management instance and verify that a new file is created on the storage account.

   ## Lab 3
   ### Confiugre the Storage Account for subscribing an event on the Event Grid instance each time a file is created or deleted on the container.
   #### Steps

1. In the left panel of our storage account, click in "Events" and proceed to configure the event to subscribe.
2. Click in "Configure endpoint" and fill with the worlflow URL of the logicapp-2-xxxx.
3. Save the changes.

## Lab 4
### Configure the logicapp-2-xxxx for inserting the details of the order on a SQL database table. This, every time a new order file is created on the storage account and the event subscription is generated on the Event Grid instance.
#### Steps

1. In the Azure Portal go to the workflow of the logicapp-2-xxxx and under the "Switch" add the "Case Blob Storage Created". Now, every time a new file order is created in the storage account and the corresponing Event grid event is subscribed on it, the logic app will trigger and record the order details on the Azure SQL database table.
2. Save the changes.
3. Test from the API Management instance and veirfy that a new record is generated on our Azure SQL database. This, using a Azure Data Studio and adding the Azure SQL database connection string.
   
   Azure SQL Connection:
   From the Azure portal go to our Azure SQL instance >> Overview >> Server name.
   From the VS Code, go to ".env" file and look for the keys and values for the user and password for connecting to our database.

##Lab 5
### Configure the logicapp-2-xxxx for sending an email message each time a new order file is de;eted fron the storage account and the event subscription is generated on the Event Grid instance.
#### Steps

1. In the Azure Portal go to the workflow of the logicapp-2-xxxx and under the "Switch" add the "Case Blob Storage Deleted". Now, every time a new file order is deleted in the storage account and the corresponing Event grid event is subscribed on it, the logic app will trigger and will send an email message with the details.
2. Save the changes.
3. Delete a file from the storage account and verify the configured email.

